---
title: HSM Support
description: How to configure Hardware Security Modules to manage your Teleport CA private keys
h1: Teleport HSM Support
---

This guide will show you how to set up the Teleport Auth Service to use a
hardware security module (HSM) to store and handle private keys.

<ScopedBlock scope={["oss", "cloud"]}>

This guide is intended for Teleport Enterprise users.

</ScopedBlock>

## Prerequisites

- Teleport v(=teleport.version=) Enterprise (self-hosted).

- The `tctl` administration tool version >= (=teleport.version=).

  (!docs/pages/includes/tctl.mdx!)

- An HSM reachable from your Teleport auth server.

- The PKCS#11 module for your HSM.

<Admonition type="warning" scope={["cloud", "oss"]} opened={true} scopeOnly={true} title="Compatibility Warning">
Teleport Cloud and Teleport Open Source do not currently support HSM.

</Admonition>

While most PKCS#11 HSMs should be supported, the Teleport team tests with AWS
CloudHSM, YubiHSM2, and SoftHSM2.

## Step 1/5. Set up your HSM

You will need to set up your HSM and make sure that it is accessible from your
Teleport Auth Server. You should create a unique HSM user or token for Teleport
to use.

<Tabs>
  <TabItem label="AWS CloudHSM">
Before getting started, you should create and activate a CloudHSM cluster in
the VPC where you will run your Teleport Auth Server. Create a Crypto User (CU)
to be used by Teleport. See the AWS CloudHSM
[User Guide](https://docs.aws.amazon.com/cloudhsm/latest/userguide/getting-started.html)
for help.

On the EC2 instance where you will run your Teleport Auth Server:

1. Add the security group with the same name as your CloudHSM cluster to your
   EC2 instance to allow incoming traffic from CloudHSM on ports 2223â€“2225.

2. Install and configure the CloudHSM client by following
   https://docs.aws.amazon.com/cloudhsm/latest/userguide/install-and-configure-client-linux.html.

3. Start the CloudHSM client.
   ```code
   $ sudo systemctl start cloudhsm-client
   ```

4. Install the AWS CloudHSM Client SDK 3 by following
   https://docs.aws.amazon.com/cloudhsm/latest/userguide/pkcs11-library-install.html.

   This step installs the PKCS#11 module at `/opt/cloudhsm/lib/libcloudhsm_pkcs11.so`
  </TabItem>

  <TabItem label="YubiHSM2">
1. Install the YubiHSM2 [SDK](https://developers.yubico.com/YubiHSM2/Releases/).

   <Admonition type="warning">
     The YubiHSM2 SDK version `2023.01` is currently unsupported.
     The latest known supported version is `2022.06`.
   </Admonition>

2. Start `yubihsm-connector` with debug logging enabled. This is a background
   process that you will need to keep running to facilitate connections to your
   YubiHSM2.

   ```code
   $ yubihsm-connector -d
   DEBU[0000] preflight complete                            cert= config= key= pid=73502 seccomp=false serial= syslog=false timeout=0s version=3.0.3
   DEBU[0000] takeoff                                       TLS=false listen="localhost:12345" pid=73502
   ```
3. Use `yubihsm-shell` to create a new authentication key to be used by
   Teleport with the necessary capabilities.

   YubiHSM2 comes with a factory default authentication key at slot 1 with password
   `password`. You should replace and delete it as recommended by Yubico.

   When creating the authentication key to be used by Teleport, the password
   must have at least 8 characters. The example `hunter22` is used here.

   ```text
   $ yubihsm-shell
   Using default connector URL: http://localhost:12345
   yubihsm> connect
   Session keepalive set up to run every 15 seconds
   yubihsm> session open 1 password
   Created session 0

   # Create an Authenticate Key for Teleport
   yubihsm> put authkey 0 0 "Teleport Auth Key" 1 generate-asymmetric-key:sign-pkcs:delete-asymmetric-key sign-pkcs:sign-pss:decrypt-pkcs:decrypt-oaep hunter22
   Stored Authentication key 0x85cf

   # Make sure you can open a session with the new authentication key and password
   yubihsm> session open 0x85cf hunter22
   Created session 1

   # Delete the factory default authentication key
   yubihsm> delete 0 1 authentication-key
   ```

   Take note of the slot number of the new authentication key.
   In the above example this is the hex value `0x85cf`.
   This will need to be included in your Teleport configuration file in a later
   step.

4. Create a `yubihsm_pkcs11.conf` file to configure the address and port that
   `yubihsm-connector` is listening on and enable debug logging:

   ```text
   # /etc/yubishm_pkcs11.conf
   connector = https://127.0.0.1:12345
   debug
   ```

5. Set the environment variable `YUBIHSM_PKCS11_CONF` to the path of your
   configuration file.
   This will be read by the PKCS#11 module and needs to be set in the Teleport
   auth server's environment.
   ```code
   $ export YUBIHSM_PKCS11_CONF=/etc/yubihsm_pkcs11.conf
   ```
  </TabItem>
</Tabs>

## Step 2/5. Configure Teleport

To configure Teleport to use an HSM for all CA private key generation, storage,
and signing, include the `ca_key_params` section in `/etc/teleport.yaml` on the
auth server.

<Tabs>
  <TabItem label="AWS CloudHSM">
```yaml
# /etc/teleport.yaml
teleport:
  ...

auth_service:
  enabled: true
  ...

  ca_key_params:
    pkcs11:
      module_path: /opt/cloudhsm/lib/libcloudhsm_pkcs11.so
      # token_label should always be "cavium" for CloudHSM
      token_label: "cavium"
      pin: "<CU_username>:<CU_password>"
      # pin_path can optionally be used to read the pin from a file
      # pin_path: /path/to/pin_file
```
  </TabItem>

  <TabItem label="YubiHSM2">
```yaml
# /etc/teleport.yaml
teleport:
  ...

auth_service:
  enabled: true
  ...

  ca_key_params:
    pkcs11:
      # this is the default installation path for Yubico's PKCS#11 module
      module_path: /usr/local/lib/pkcs11/yubihsm_pkcs11.dylib
      # slot_number should always be set to 0 for YubiHSM2
      slot_number: 0
      # pin should be the (hex) slot number of your authentication key,
      # concatenated with the password
      pin: "85cfhunter22"
      # pin_path can optionally be used to read the pin from a file
      # pin_path: /path/to/pin_file
```
  </TabItem>
</Tabs>

## Step 3/5. (Re)start Teleport Auth

If this is a new auth server which has not been started yet, starting a brand
new cluster with an empty backend, HSM keys will be automatically generated at
startup and no further action is required, skip to step 5. Otherwise, continue
reading.

If you are connecting an HSM to an existing Teleport cluster, restart the auth
server for the configuration changes to take effect. New CA keys will
automatically be generated in the HSM. For these keys to be trusted by the rest
of the cluster you will need to perform a CA rotation, see
[Step 4](#step-45-certificate-rotation-with-hsm). The auth server will not perform
any signing operations until the rotation has started. In an HA cluster you
should add the HSM to the auth configuration one server at a time, and do not
route any traffic to the auth server where the HSM is currently being added.

## Step 4/5. Certificate Rotation with HSM

When adding a new HSM to an existing Teleport cluster, or adding a new
HSM-connected Auth server to an HA Teleport cluster, you will need to rotate all
Certificate Authorities in order for new certificates to by issued and
trusted.

`tctl status` will print a warning if CA rotation is required:
```code
$ tctl status
WARNING: One or more auth servers has a newly added or removed HSM or KMS configured. You should not route traffic to that server until a CA rotation has been completed.
Cluster      cluster-one
Version      13.0.0-alpha.1
host CA      never updated
user CA      never updated
db CA        never updated
openssh CA   never updated
jwt CA       never updated
saml_idp CA  never updated
CA pin       sha256:29afff5a1c1231375525b8a9b98ea7a44a760b7e65de3ca2e04d72db39b1672b
CA pin       sha256:e758c8f0f6cd95116d5da8171e0ff4adfa99dab3b1f171bfe854070884955524
```

`teleport start` will also print a warning during startup if any CA needs to be rotated.
Until rotation is completed, the auth server will not sign any new certificates
(except the `Admin` certificate used by `tctl` which will be signed by a
temporary HSM key).

CA rotation can be performed manually or semi-automatically, see our admin guide
on [Certificate rotation](../../management/operations/ca-rotation.mdx).
All CAs listed in the output of `tctl status` must be rotated.

## Step 5/5. Confirm that Teleport is using your HSM

You are all set! Check the teleport logs for `Creating new HSM key pair` to
confirm that the feature is working. You can also check that keys were created
in your HSM using your HSM's admin tool.

