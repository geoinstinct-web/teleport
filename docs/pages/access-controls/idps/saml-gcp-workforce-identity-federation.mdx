---
title: GCP Workforce Identity Federation
description: Manage GCP Web Console with Teleport as SAML identity provider.
h1: GCP Web Consle access with Teleport
---

GCP Workforce Identity Federation enables provisioning access to GCP web console and APIs
for identities that are not managed within Google Workspace admin or GCP Cloud Identity.

The general workflow of configuring the Workforce Identity Federation is to first create a workforce pool.
Then the next step is to create and configure a pool identity provider. Once a pool identity provider
is configured, user's can sign in into GCP web console as long as their identity is signed by the identity
provider in a federated authentication process.


This guide details how to integrate GCP workforce Identity Federation service with Teleport SAML IdP, so users can sign in into GCP web console by authenticating with Teleport.


## Prerequisites

(!docs/pages/includes/no-oss-prereqs-tabs.mdx!)

- (!docs/pages/includes/tctl.mdx!)
- If you're new to SAML, consider reviewing our [SAML Identity Provider
Reference](./saml-reference.mdx) before proceeding.
- User with permission to create service provider resource. The preset `editor` role has this permission.
- Access to GCP IAM api, with permission to create Workforce Identity Pool and IAM policy.



Teleport Web UI offers both the guided configuration flow and manual flow for GCP Workforce Identity Federation. Manual flow is similar to how you enroll any SAML service provider to Teleport. In Guided flow, from the SAML service provider discovery flow in the Web UI, you can generate an installation script, which will set up a workforce pool and pool provider to help you quickly get started with the integration.

## Guided Configuration flow
Create a workforce pool and pool provider with the script generated by Teleport.

In the Web UI, under **Access Management**, click **Enroll New Resource** menu.
In the search box, enter “workforce”, which will show the Workforce Identity Federation integration tile. Click the tile. Now follow the steps listed below.

## Step 1/3. Configure Workforce Pool
As a first step, provide the following information to the script generator.

- **Organization ID:** Organization ID of GCP account. The ID is required to create a workforce pool.
- **Pool Name:** Name of the workforce pool to be created.
- **Pool Provider Name:** Name of the workforce pool provider to be created. Pool provider name will also be used as SAML service provider name in the next step.

Click on **Generate Script** button. Teleport Web UI will now show you a copyable bash script.

Open GCP Cloud Shell and inside the Cloud Shell terminal, paste the bash script you copied above.


The script, when executed, downloads another bash script using curl. This downloaded bash script is configured to download and run a teleport binary. Upon downloading the teleport binary, the bash script executes the `teleport integration configure samlidp gcp-workforce` command which creates a workforce pool and a workforce pool identity provider with resource names you provided above. 

Once the workforce pool and pool provider is created, head back to Teleport Web UI and follow the steps below.

## Step 1/2 Add Workforce Pool To Teleport

Proceed to the next step in the UI by clicking the **Next** button.

In this step, you will find that the SAML IdP service provider name, Entity ID, ACS URL and one attribute mapping field with attribute name "roles" is already populated for you. These values are generated by Teleport based on GCP configuration values provided in the previous step.

Note: If you update pool name, pool provider name or attribute mapping in GCP, those values must be updated in the Teleport as well. 

Click **Finish** button. The workforce pool will be now added to Teleport as a SAML IdP service provider resource. 


## Step 1/3 Assigning GCP permission.

Once a pool and pool provider is configured in the GCP, and its respective configuration is added to Teleport as a SAML service provider resource, users can sign in into the GCP web console, as long as their Teleport roles permit them to access SAML resources.

Though, at this stage, the authenticated user will only be able to sign in into the GCP web console and they won't be able to access any resources yet. For that, GCP IAM policy must be created with the desired roles for users.


Head over to the GCP Cloud Shell again to create an IAM policy. 

The process of creating an IAM policy for the workforce pool is similar to how you configure GCP IAM policy in general, with the only difference being that for the member field, you need to reference the workforce principal value which identifies the external user or user group.


For example, the following `gcloud` command demonstrates creating an IAM policy for a user with a permissions to browse GCP projects.

```
gcloud projects add-iam-policy-binding GCP_PROJECT_ID \
  --role="ROLE_NAME" \
  --member="WORKFORCE_POOL_PRINCIPAL"
```

Where 
`GCP_PROJECT_ID` is name of GCP project ID
`ROLE_NAME` is a name of GCP IAM role, e.g. ”roles/browser”
`WORKFORCE_POOL_PRINCIPAL` is a principal identifier. E.g. `principal://iam.googleapis.com/locations/global/workforcePools/<pool name>/subject/test@example.com`


A working command would resemble as the following example:

```
gcloud projects add-iam-policy-binding <GCP_Project_ID> \
  --role=”roles/browser”  \
  --member=”principal://iam.googleapis.com/locations/global/workforcePools/<pool ID>/subject/test@example.com”
```

Note: The steps listed above can also be performed in the GCP Web Console.



## Access Management

An important thing to consider is that the GCP workforce pool and pool identity prodiver are created at the organization level. It is by creating an IAM policy at the project level that you can configure a granular access control, binding each workforce pool to specific projects and its resources. 

Creating multiple workforce pools and configuring them with multiple workforce identity providers (added as an individual SAML IdP service provider in Teleport) is a recommended way to configure granular access control to GCP resources.


#### Mapping access to GCP based on Teleport roles

To map access to GCP resources based on Teleport roles, you will need to create an IAM policy that binds to `principalSet` referencing the Teleport role name.

For example, to create an access policy such that Teleport users with role `gcp-dev` are assigned with GCP role `roles/browser`, you have to the following `gcloud` command shows the IAM policy created for role name `gcp-dev`. 

First, the workforce pool identity provider configuration must be configured with an attribute mapping that maps the Teleport role to GCP groups. `google.groups=assertion.attributes.roles`

Next, an IAM policy must be created mapping a GCP group. 

```
gcloud projects add-iam-policy-binding <GCP_Project_ID> \
  --role=”roles/browser”  \
  --member=”principalSet://iam.googleapis.com/locations/global/workforcePools/<pool name>/group/gcp-dev”
```
Since Teleport group is mapped as GCP group with attribute mapping, the policy will grant Teleport user group `gcp-dev`. 


For general reference on SAML IdP attribute mapping, please refer to the attribute mapping docs and how you can [represent workforce pool users in IAM policies](https://cloud.google.com/iam/docs/configuring-workforce-identity-federation#representing-workforce-users). 

#### Access condition

Access conditions can be used to control which users can be admitted to the GCP workforce pool. For example, if you only want to ensure that a Teleport user with a role name `gcp-prod` should be admitted to GCP pool, you can create the following access condition in the workforce pool provider.  

```
"gcp-prod" in assertion.attributes.roles
```


## Manual integration

While guided integration is easy to get started, advance configuration requirements should follow a manual integration. Both the Web UI and Teleport `tctl` client can be used for manual configuration. 

### Manually creating workforce pool and pool provider

```
gcloud iam workforce-pools create <POOL_NAME> \
       --display-name=<POOL_NAME> \
       --organization=<GCP_ORGANIZATION_ID> \
       --description="Teleport workforce pool"
```

Download Teleport SAML IdP metadata file. `<proxy_host>/enterprise/saml-dp/metadata`

```
gcloud iam workforce-pools providers create-saml <POOL_PROVIDER_NAME> \
       --workforce-pool=<POOL_NAME> \
       --display-name=<POOL_PROVIDER_NAME> \
       --description="Teleport workforce identity provider" \
       --idp-metadata-path="<METADATA_FILE_PATH>" \
       --attribute-mapping=”google.subject=assertion.subject,google.groups=assertion.attributes.roles" \
       --location=global
```

Please refer to the GCP Workforce Identity Federation docs for canonical reference - https://cloud.google.com/iam/docs/configuring-workforce-identity-federation

### Workforce pool provider Entity ID and ACS URL


Entity ID: 
`https://iam.googleapis.com/locations/global/workforcePools/WORKFORCE_POOL_ID/providers/PROVIDER_ID`

ACS URL: `https://auth.cloud.google/signin-callback/locations/global/workforcePools/WORKFORCE_POOL_ID/providers/WORKFORCE_PROVIDER_ID`



