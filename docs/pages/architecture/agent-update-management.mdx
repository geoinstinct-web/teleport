---
title: Agent Update Management 
description: This chapter explains how Teleport agent automatic update is working.
---

While many Teleport resources [support agentless
mode](../faq.mdx#can-teleport-be-deployed-in-agentless-mode), agent deployments
are sometimes simpler and more convenient. However, large Teleport deployments
can create an additional burden: updating all agents.

Starting with version 13, Teleport supports automatic agent updates for systemd-based
Linux distributions using `apt` or `yum` package managers, and Kubernetes clusters.

## Update logic and failure modes

An updater is a piece of software deployed next to an agent which is responsible
for updating it. Updating multiple agents requires multiple updaters.

We designed the updater to be as decoupled from Teleport as possible. The
updater can update agents even when they cannot join the Teleport cluster.
Pushing a broken version can happen, but a rollback/roll-forward must always
be possible without manually connecting to the resource and fixing the agent.

The updater recurrently fetches the target version from a version server and
updates the agent to the target version. Because restarting the agent can
disrupt currently open sessions, it will only update the agent in two cases:
during a maintenance window or when the agent is unhealthy.

When enrolled in a cluster with automatic updates, the agent will retrieve
its maintenance schedule from the Teleport cluster and save it. When a
maintenance schedule is available, the updater will honour it. However, if
the updater cannot find the maintenance schedule, it will consider the agent
unhealthy and perform updates as soon as possible. Similarly, if the updater
detects the agent is unhealthy, it immediately applies any pending update to
try to recover from a degraded state.

We implemented an additional failsafe: the critical maintenance toggle.
The version server can specify that an update is critical. Critical updates are
applied even if the updater is outside its regular maintenance window.

## Security

When updating the agent, the updater will ensure the new version's authenticity
before deploying it. On Linux distributions using `apt` or `yum`, it relies on
the existing package signature system. On Kubernetes-based environments, it
validates the OCI image signature (using [cosign's signature
](https://github.com/sigstore/cosign/blob/main/specs/SIGNATURE_SPEC.md)).

## Version server and source of truth

The agent version is subject to the following constraints:

- the agent must never exceed the Proxy or Auth Service version,
- the agent must always be no more than one major version below the Proxy or Auth
  Service version.

The best practice is to always align the agent version with the Proxy and Auth
ones. To upgrade Auth and Proxy, follow [the Teleport Cluster upgrade guide
](../upgrading.mdx).

For this reason, all updaters must subscribe to a release channel targeting
versions that are compatible with their Teleport cluster. Teleport Cloud users
must use the Teleport Cloud version server with the `stable/cloud` release
channel. Self-hosted Teleport users must host their own version server and
either update their release channel each time they update their Auth and Proxy
instances, or use the `stable/rolling` channel.

### Teleport Cloud

Teleport Cloud users can use Teleport Cloud's version server only if their
instance is enrolled in automatic updates. This version server will always
target the best version from a feature, compatibility, security and stability
point of view.

Teleport Cloud users whose control plane is not automatically updated must not use
automatic agent updates. This is because their Teleport instance version might
differ from the other Teleport Cloud instances and might not yet support the
latest agent version.

### Self-hosted Teleport

Self-hosted Teleport users can set up automatic agent updates. They must host
their version server and choose their target version. They are responsible for
ensuring the targeted version is compatible with their current auth/proxy
versions. They must also monitor the agent's health and rollout status to
ensure every agent is healthy and running the correct version.

## Teleport updater package

Teleport supports an APT and YUM repository. This is where the `teleport` (oss) and
`teleport-ent` (enterprise) packages can be found. The updater is also now available
in the Teleport repository under the `teleport-ent-updater` package. The `teleport-ent-updater`
package provides a `teleport-upgrade` tool that is capable of identifying the latest
compatible Teleport agent version and performing an update of the Teleport agent.
On installation, a systemd service named `teleport-upgrade.service` is also enabled
that periodically checks for an available update, and applies an update when able.

The `teleport-upgrade` tool provides some basic commands to verify and perform an
update of the Teleport agent.

```code
$ teleport-upgrade help
USAGE: /usr/sbin/teleport-upgrade <command>

Tool for automatic upgrades of Teleport agents.

Commands:
  run           check for and potentially apply a teleport upgrade.
  dry-run       check for new teleport version but do not upgrade.
  version       print the current version of /usr/sbin/teleport-upgrade.
  help          show this help text.
```

The `dry-run` command can be used to check for an available update without performing
an update.
```code
# Example output when teleport is already on the latest compatible version.
$ teleport-upgrade dry-run
[i] no upgrades available (14.3.14 == 14.3.14) [ 582 ]

# Example output when an update is available.
$ teleport-upgrade dry-run
[i] an upgrade is available (13.4.14 -> 14.3.14) [ 585 ]
[i] within maintenance window, upgrade will be attempted. [ 596 ]
```

The `run` command performs an update if available.
```code
# Successful teleport update from 13.4.14 to 14.3.14.
$ teleport-upgrade run
[i] an upgrade is available (13.4.14 -> 14.3.14) [ 585 ]
[i] within maintenance window, upgrade will be attempted. [ 596 ]
[i] attempting apt install teleport-ent=14.3.14... [ 480 ]
[...]
[i] gracefully restarting Teleport (if already running) [ 449 ]

# Teleport updates are not attempted when outside the maintenance window.
$ teleport-upgrade run
[i] an upgrade is available (13.4.14 -> 14.3.14) [ 585 ]
[i] upgrade is non-critical and we are outside of maintenance window, not attempting. [ 618 ]
```

## Version locking

Due to the fact that Teleport has strict [version compatibility requirements](../faq.mdx#which-version-of-teleport-is-supported),
the updater requires full control over the version of Teleport. As of Teleport
`15.1.10+`, a version locking mechanism is supported by the updater. This mechanism
locks the version of Teleport and prevents manual updates of the Teleport package.
This prevents unintentinal updates during routine system maintenance, or an accidental
update by a user. The updater still has the capability to update the Teleport package,
and all updates of Teleport are expected to be performed by the updater.

### Bypass version lock

The version locking mechanism is implemented using the features of the package managers.
In case a user would like to manually update the Teleport version, this can be done
with the following commands.

With the APT package manager CLI, the `--allow-change-held-packages` flag must be provided
to bypass the version lock.
```code
$ apt-get install --allow-change-held-packages "teleport-ent=<target-version>"
```

With the YUM package manager CLI, the `--disableexcludes="teleport"` flag must be provided
to bypass the version lock.
```code
$ yum install --disablerepo="*" --enablerepo="teleport" --disableexcludes="teleport" "teleport-ent-<target-version>"
```

With the ZYPPER package manager CLI, the lock must be disabled and then re-enabled
after the update.
```code
$ zypper removelock "teleport-ent"
$ zypper install --repo="teleport" "teleport-ent-<target-version>"
$ zypper addlock "teleport-ent"
```

## Updating the updater

The updater is designed to be minimal and relatively stable, but the updater will
receive updates on occasion. Currently, the updater does not have the capability
to update itself. Updates to the `teleport-ent-updater` package must be done manually.

The `teleport-ent-updater` will be backwards compatible with older versions of Teleport,
so you can alwasy update the `teleport-ent-updater` package to the latest available
version.

## Next steps

Self-hosted users must first [set up self-hosted automatic agent upgrades
](../upgrading/self-hosted-automatic-agent-updates.mdx).

After that, you can set enroll agents in automatic updates as part of the
[upgrading procedure](../upgrading.mdx).
