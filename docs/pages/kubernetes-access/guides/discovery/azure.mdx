---
title: Teleport AKS auto-discovery (Preview)
description: Auto-discovery of AKS clusters in Azure cloud.
---

Similarly to [EKS discovery](./aws.mdx), AKS Discovery can automatically discover 
any Azure AKS cluster and enroll it if its labels match the configured labels.

As mentioned in [Kubernetes Discovery](./discovery.mdx), the discovery process 
requires two separate Teleport components. The first, `discovery_service`, is 
responsible for watching the cloud provider and checking if there are any 
new clusters or if there have been any modifications to previously discovered clusters. 
The `kubernetes_service` monitors the clusters created by `discovery_service` and 
is responsible for authenticating into them and forwarding the requests.

<Notice type="tip">

This guide presents the `discovery_service` and `kubernetes_service` running in 
the same process, however both can run independently and on different machines. To do 
that, you just need to create a valid token for each of the roles and separate their 
configurations. Running the processes independently is beneficial if access 
to different clusters requires `kubernetes_service` to be on the same network as 
the cluster.

</Notice>

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- Azure identity with permissions to list AKS clusters and allowed to 
access those clusters.
- AKS clusters running. 

## Step 1/2. Set up Azure Identity with required permissions

Depending on the Authentication and Authorization configuration of each cluster, 
Teleport requires a different set of permissions to access it. 
In some configurations, Teleport has the ability to automatically set up your 
cluster access if you set the permissions to do so.

Check the authentication modes used in your clusters and choose one or more 
permissions scenarios for Teleport.

<Tabs>
  <TabItem label="Azure AD + Azure RBAC (recommended)" >

In this scenario, Teleport authentication on the cluster is done through 
Active Directory and the permissions are associated with the role assignments 
configured in the Teleport identity. 

Create a role with the following content and assign it to the identity that the 
Teleport process will use.

```json
  {
      "Name": "AKS Teleport Discovery",
      "Description": "Required permissions for Teleport auto-discovery.",
      "Actions": [
        "Microsoft.ContainerService/managedClusters/read",
        "Microsoft.ContainerService/managedClusters/listClusterUserCredential/action"
      ],
      "NotActions": [],
      "DataActions": [
        "Microsoft.ContainerService/managedClusters/groups/impersonate/action",
        "Microsoft.ContainerService/managedClusters/users/impersonate/action",
        "Microsoft.ContainerService/managedClusters/serviceaccounts/impersonate/action",
        "Microsoft.ContainerService/managedClusters/pods/read",
        "Microsoft.ContainerService/managedClusters/authorization.k8s.io/selfsubjectaccessreviews/write",
        "Microsoft.ContainerService/managedClusters/authorization.k8s.io/selfsubjectrulesreviews/write",
      ],
      "NotDataActions": [],
      "assignableScopes": [
          "/subscriptions/{subscription_id}"
      ]
  }
```

Replace the `{subscription_id}` with the desired subscription id or a wildcard if 
you want to guarantee permissions on all subscriptions.

  </TabItem>

  <TabItem label="Azure AD + Kubernetes RBAC">
When using Azure AD authentication with Kubernetes RBAC mode, Azure is responsible 
for user authentication using AD credentials but permissions management is Kubernetes' 
responsibility.

Therefore, for Teleport to operate correctly it is necessary to configure 
`ClusterRole` and `ClusterRoleBinding` for one of the AD groups assigned to the identity.

Teleport has the ability to create the `ClusterRole` and `ClusterRoleBinding` resources 
in the following cases:
- Teleport identity has access to the cluster administrator credentials, and they are static (Local Accounts).
- Teleport identity belongs to the cluster administrator group.
- Teleport identity has permissions to create `ClusterRole` and `ClusterRoleBinding` on the 
cluster and permissions to execute remote commands.

In either of the specified cases, Teleport will create the `ClusterRole` and bind 
it to the first group it belongs to. To make this possible, associate the 
following permissions with the Teleport's identity.

    ```json
      {
          "Name": "AKS Teleport Discovery",
          "Description": "Required permissions for Teleport auto-discovery.",
          "Actions": [
            "Microsoft.ContainerService/managedClusters/read",
            "Microsoft.ContainerService/managedClusters/listClusterAdminCredential/action",
            "Microsoft.ContainerService/managedClusters/listClusterUserCredential/action",
            "Microsoft.ContainerService/managedClusters/runcommand/action",
            "Microsoft.ContainerService/managedclusters/commandResults/read"
          ],
          "NotActions": [],
          "DataActions": [],
          "NotDataActions": [],
          "assignableScopes": [
              "/subscriptions/{subscription_id}"
          ]
      }
    ```

In all other cases, a manual action is required to set up access as described in the guide below.

<Details 
title="Manual configuration of Teleport RBAC permissions" 
opened={false}
>

Connect to each one of your target clusters with admin permissions and create the following 
resources using `kubectl`.

#### ClusterRole

Create the `ClusterRole` RBAC definition with minimum permissions for the Teleport 
to forward requests to the cluster.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: teleport
rules:
- apiGroups:
  - ""
  resources:
  - users
  - groups
  - serviceaccounts
  verbs:
  - impersonate
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
- apiGroups:
  - "authorization.k8s.io"
  resources:
  - selfsubjectaccessreviews
  - selfsubjectrulesreviews
  verbs:
  - create
```

#### ClusterRoleBinding

Link the previously created `ClusterRole` into the Teleport group.

```yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: teleport
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: teleport
subjects:
- kind: Group
  name: {azure_ad_group_id}
  apiGroup: rbac.authorization.k8s.io
```

Please replace `{azure_ad_group_id}` with the appropriate Azure AD group
associated with Teleport identity.

</Details>


  </TabItem>
    <TabItem label="Local Accounts">
      In this case, Teleport will use the user credentials generated during the 
      provisioning phase of the cluster. 

    ```json
      {
          "Name": "AKS Teleport Discovery",
          "Description": "Required permissions for Teleport auto-discovery.",
          "Actions": [
            "Microsoft.ContainerService/managedClusters/read",
            "Microsoft.ContainerService/managedClusters/listClusterUserCredential/action",
          ],
          "NotActions": [],
          "DataActions": [],
          "NotDataActions": [],
          "assignableScopes": [
              "/subscriptions/{subscription_id}"
          ]
      }
    ```

  </TabItem>
</Tabs>


## Step 2/2. Configure Teleport to discover AKS clusters

The Teleport Kubernetes Discovery requires a valid auth token for the `discovery` and `kube` services 
to connect to the cluster. Generate one by running the following command against
your Teleport Auth Service and save it in `/tmp/token` on the Node
that will run the Kubernetes Discovery:

```code
$ tctl tokens add --type=discovery,kube
```

To enable AKS cluster discovery the, `discovery_service.azure` section must
include at least one entry and must specify the `aks` type. It 
is also required to configure the `kubernetes_service.resources.tags` to use the same
labels configured at `discovery_service.azure[:].tags` or a subset of them 
in order to make `kubernetes_service` listen to the dynamic resources created by 
the discovery service.

```yaml
version: v2
teleport:
  join_params:
    token_name: "/tmp/token"
    method: token
  auth_servers:
  - "teleport.example.com:3080"
auth_service:
  enabled: off
proxy_service:
  enabled: off
ssh_service:
  enabled: off
discovery_service:
  enabled: "yes"
  azure:
  - types: ["aks"]
    regions: ["*"]
    subscriptions: ["*"]
    resource_groups: ["*"]
    tags:
      "env": "prod"
kubernetes_service:
  enabled: "yes"
  resources:
  - labels:
      "env": "prod" # Match Kubernetes Cluster labels specified earlier
```

Once Teleport is configured for discovery, it can be started and AKS
clusters matching the tags specified in the AWS section will be added 
to the Teleport cluster automatically.

## Troubleshooting

(!docs/pages/kubernetes-access/guides/discovery/includes/troubleshooting.mdx!)