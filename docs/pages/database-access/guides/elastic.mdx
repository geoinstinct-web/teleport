---
title: Database Access with Elasticsearch
description: How to configure Teleport Database Access with Elasticsearch.
---

<Details
  title="Version warning"
  opened={true}
  scope={["oss", "enterprise"]}
  scopeOnly={true}
  min="10.3"
>
  Database access for Elasticsearch is available starting from Teleport `10.3`.
</Details>

This guide will help you to configure secured access to an Elasticsearch database using Teleport Dabatase Access.

## Prerequisites

- A self-hosted Elasticsearch database. Elastic Cloud [does not support client certificates](https://www.elastic.co/guide/en/cloud/current/ec-restrictions.html#ec-restrictions-security), which are required for setting up Database Access.

- A host where you will run the Teleport Database Service. Teleport version 10.3
  or newer must be installed. <ScopedBlock scope={["oss", "enterprise"]}> This can also be the same instance of Teleport running your Auth and/or Proxy service(s).</ScopedBlock>

  See [Installation](../../installation.mdx) for details.

(!docs/pages/includes/user-client-prereqs.mdx!)

## Step 1/5. Install and configure Teleport

### Set up the Teleport Auth and Proxy Services

(!docs/pages/includes/database-access/start-auth-proxy.mdx!)

### Set up the Teleport Database Service

(!docs/pages/includes/database-access/token.mdx!)

Install Teleport on the host where you will run the Teleport Database Service. Make sure you've selected your installation type (OSS, Enterprise, Cloud):

(!docs/pages/includes/install-linux.mdx!)

Start the Teleport Database Service, pointing the `--auth-server` flag to the
address of your Teleport Proxy Service:

<Tabs>
<TabItem label="Standalone Binary">

```code
$ teleport db start \
  --token=/tmp/token \
  --auth-server=teleport.example.com:3080 \
  --name=myelastic \
  --protocol=elastic \
  --uri={ELASTICSEARCH_HOST}:9200 \
  --labels=env=dev
```

</TabItem>
<TabItem label="Config File">
Add the following block to `teleport.yaml`
```yaml
db_service:
  enabled: true
  resources:
  - labels:
      "*": "*"
  databases:
  - name: myelastic
    protocol: elasticsearch
    uri: {ELASTICSEARCH_HOST}:9200
    static_labels:
      env: dev
```

Adjust for your environment, then start or restart Teleport.

</TabItem>
</Tabs>

<Admonition type="note">

The `--auth-server` flag must point to the Teleport cluster's Proxy Service
endpoint because the Database Service always connects back to the cluster over a
reverse tunnel.

</Admonition>

<Admonition type="tip">
  You can start the Database Service using a configuration file instead of CLI flags.
  See the [YAML reference](../reference/configuration.mdx) for details.
</Admonition>

## Step 2/5. Create or modify a Teleport user

(!docs/pages/includes/database-access/create-user.mdx!)

Alternately, you can edit an existing user with database access.

1. As a Teleport user with the `editor` role, import a user's configuration to a local `yaml` file:

   ```code
   $ tctl get user/{teleport-user} > user.yaml

   ```

2. Modify `spec.traits.db_names` and `spec.traits.db_users` with the name(s) and database user(s) this user should have access to, or use `*` to provide access to all databases/users:

    ```yaml
    ...
    spec:
      ...
      traits:
      ...
      db_names:
      - '*'
      db_users:
      - '*'
      ...
    ```

3. Apply the changes to the Teleport user:

   ```code
   $ tctl create -f user.yaml
   user "teleport-user" has been updated
   ```

## Step 3/5. Create a role mapping

Define a role mapping in Elasticsearch to assign your Teleport user or role to an Elasticsearch role.
The example below maps the Teleport user `alice` to the `superuser` role in Elasticsearch, which
should **not** be done in production:

```code
$ curl -u elastic:{ELASTICSEARCH_USER_PASSWORD} -X POST "https://{ELASTICSEARCH_HOST}:9200/_security/role_mapping/mapping1?pretty" -H 'Content-Type: application/json' -d'
{
  "roles": [ "superuser"],
  "enabled": true,
  "rules": {
    "field" : { "username" : "alice" }
  },
  "metadata" : {
    "version" : 1
  }
}
'
```

## Step 4/5. Set up mutual TLS

(!docs/pages/includes/database-access/tctl-auth-sign.mdx!)

We will show you how to use `tctl auth sign` below.

To securely access your Elasticsearch database, sign the certificate for the hostname Teleport will
connect to.

For example, if your Elasticsearch server is accessible at `elastic.example.com`,
run:

```code
$ tctl auth sign --format=elastic --host=elastic.example.com --out=elastic --ttl=2160h
Database credentials have been written to elastic.key, elastic.crt, elastic.cas.
```

(!docs/pages/includes/database-access/ttl-note.mdx!)

The command will create three files:

- `elastic.cas` with Teleport's certificate authority
- `elastic.key` with a generated private key
- `elastic.crt` with a generated user certificate

You will need these files to enable mutual TLS on your Elasticsearch server.

(!docs/pages/includes/database-access/rotation-note.mdx!)

Use the generated secrets to enable mutual TLS in your `elasticsearch.yml` configuration
file:

```yml
xpack.security.http.ssl:
  certificate_authorities: /path/to/elastic.cas
  certificate: /path/to/elastic.crt
  key: /path/to/elastic.key
  enabled: true
  client_authentication: required
  verification_mode: certificate

xpack.security.authc.realms.pki.pki1:
  order: 1
  enabled: true
  certificate_authorities: /path/to/elastic.cas
```

<Admonition type="tip">
For more information on configuring security settings in Elasticsearch, see:
[Security settings in Elasticsearch](https://www.elastic.co/guide/en/elasticsearch/reference/current/security-settings.html)
</Admonition>

Once mutual TLS has been enabled, you will no longer be able to connect to the cluster without
providing a valid client certificate. You can set `xpack.security.http.ssl.client_authentication`
to `optional` to allow connections from clients that do not present a certificate.

## Step 5/5. Connect

Log into your Teleport cluster and see available databases:

<Tabs>
  <TabItem label="Self-Hosted">
    ```code
    $ tsh login --proxy=teleport.example.com --user=alice
    $ tsh db ls
    Name                        Description Allowed Users Labels  Connect
    --------------------------- ----------- ------------- ------- ------------------------
    > myelastic (user: elastic)             [*]           env=dev tsh db connect myelastic
    ```
  </TabItem>
  <TabItem label="Teleport Cloud">
    ```code
    $ tsh login --proxy=mytennant.teleport.sh --user=alice
    $ tsh db ls
    Name                        Description Allowed Users Labels  Connect
    --------------------------- ----------- ------------- ------- ------------------------
    > myelastic (user: elastic)             [*]           env=dev tsh db connect myelastic
    ```
  </TabItem>
</Tabs>

To connect to a particular database instance:

```code
$ tsh tb connect myelastic --db-user=elastic
```

To log out of the database and remove credentials:

```code
#Remove credentials for a particular database instance.
$ tsh db logout myelastic
#Remove credentials for all database instances.
$ tsh db logout
```

## Next steps

(!docs/pages/includes/database-access/guides-next-steps.mdx!)
