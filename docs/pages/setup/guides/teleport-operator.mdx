---
title: Teleport Kubernetes Operator
description: Easily manage Teleport resources from Kubernetes
---

The Teleport Kubernetes Operator provides a way for Kubernetes users to manage Teleport resources like users and
roles as Kubernetes resources.

<Admonition type="note">
  Setting up the Teleport Operator is not required to
  [deploy Teleport on Kubernetes](../helm-deployments.mdx), nor setup
  [Kubernetes Access](../../kubernetes-access/introduction.mdx).
</Admonition>

This guide covers how to:
- Install Teleport Operator on Kubernetes.
- Configure Teleport users and roles using Kubernetes.

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- Kubernetes cluster that will host Teleport;
- [Helm](https://helm.sh/docs/intro/quickstart/)
- [kubectl](https://kubernetes.io/docs/tasks/tools/)

<Admonition type="tip">
  Users wanting to experiment locally with the operator can use [minikube](https://minikube.sigs.k8s.io/docs/start/)
  to start a local Kubernetes cluster:
  ```code
  $ minikube start
  ```
</Admonition>

## Step 1/3. Ensure Kubernetes cluster is running

```code
$ kubectl cluster-info
# Kubernetes control plane is running at https://127.0.0.1:6443
# CoreDNS is running at https://127.0.0.1:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
# Metrics-server is running at https://127.0.0.1:6443/api/v1/namespaces/kube-system/services/https:metrics-server:https/proxy
```

## Step 2/3. Install teleport-cluster with the operator

Add the Teleport Helm Chart [repo](https://charts.releases.teleport.dev/):
```code
$ helm repo add teleport https://charts.releases.teleport.dev
```

Install the Helm chart for the Teleport Cluster with `operator.enabled=true`.

```code
$ helm install teleport-cluster teleport/teleport-cluster \
        --create-namespace --namespace teleport-cluster \
        --set clusterName=teleport-cluster.teleport-cluster.svc.cluster.local \
        --set operator.enabled=true \
        --set teleportVersionOverride=(=teleport.version=)
```

This command installs the required Kubernetes CRDs and deploys the operator next to the Teleport cluster.
All resources except the CRDs are created in the `teleport-cluster` namespace.

All subsequents commands will take place in the `teleport-cluster` namespace, so let's use it by default:
```code
$ kubectl config set-context --current --namespace teleport-cluster
```

## Step 3/3. Manage users and roles using `kubectl`

Create the manifest `teleport-resources.yaml` describing two Custom Resources: a `TeleportUser` and a `TeleportRole`:

```yaml
apiVersion: resources.teleport.dev/v5
kind: TeleportRole
metadata:
  name: myrole
spec:
  allow:
    rules:
      - resources: ['user', 'role']
        verbs: ['list','create','read','update','delete']
---
apiVersion: resources.teleport.dev/v2
kind: TeleportUser
metadata:
  name: myuser
spec:
  roles: ['myrole']
```

Apply the manifests to the Kubernetes cluster:

```code
$ kubectl apply -f teleport-resources.yaml
```

List the created Kubernetes resources:

```code
$ kubectl get teleportroles
# NAME     AGE
# myrole   10m

$ kubectl get teleportusers
# NAME     AGE
# myuser   10m
```

Check the user `myuser` has been created in Teleport and has been granted the role `myrole`:
```code
$ PROXY_POD=$(kubectl get po -l app=teleport-cluster -o jsonpath='{.items[0].metadata.name}')
$ kubectl exec -it "$PROXY_POD" -c teleport -- tctl users ls
# User                          Roles
# ----------------------------- -----------------------------
# bot-teleport-operator-sidecar bot-teleport-operator-sidecar
# myuser                        myrole
```

At this point the Teleport Kubernetes Operator is functional and Teleport users and roles can be managed from
Kubernetes.

## Going further

### Exploring Teleport Kubernetes CRDs

Available fields can be browsed with `kubectl explain` in a cluster with Teleport CRDs installed.
For example the command:
```code
$ kubectl explain teleportroles.spec
```
Returns the following fields:
```shell
KIND:     TeleportRole
VERSION:  resources.teleport.dev/v5

RESOURCE: spec <Object>

DESCRIPTION:
    Role resource definition v5 from Teleport

FIELDS:
   allow	<Object>
     Allow is the set of conditions evaluated to grant access.

   deny	<Object>
     Deny is the set of conditions evaluated to deny access. Deny takes priority
     over allow.

   options	<Object>
     Options is for OpenSSH options like agent forwarding.
```

### Troubleshooting a resource not reconciled in Teleport

During reconciliation the operator adds a `status` field on the Kubernetes resource.
If Teleport returns an error it will be available in `status.conditions` when you retrieve a resource via `kubectl`:

```code
$ kubectl get teleportusers myuser -o yaml
```

For example, if a user has been granted a non-exising role the status will look like:

```yaml
apiVersion: resources.teleport.dev/v2
kind: TeleportUser
# [...]
status:
  conditions:
  - lastTransitionTime: "2022-07-25T16:15:52Z"
    message: Teleport resource has the Kubernetes origin label.
    reason: OriginLabelMatching
    status: "True"
    type: TeleportResourceOwned
  - lastTransitionTime: "2022-07-25T17:08:58Z"
    message: 'Teleport returned the error: role my-non-existing-role is not found'
    reason: TeleportError
    status: "False"
    type: SuccessfullyReconciled
```

Here `SuccessfullyReconciled` is `False` and the error is `role my-non-existing-role is not found`.

If the status is not present or does not give sufficient information to solve the issue, check the operator logs:

```shell
$ kubectl logs "$PROXY_POD" -c operator
```

<Admonition type="note">
  In case of multi-replicas deployments, only one operator instance is active.
  You will have to find which pod is the elected leader by looking at the logs.
</Admonition>
