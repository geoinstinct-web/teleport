---
title: Deploying Machine ID on Kubernetes
description: How to install and configure Machine ID on Kubernetes
---

Kubernetes is a popular container workload orchestrator. This document covers
deploying Machine ID as a Kubernetes workload in order to provide credentials
to other workloads running in the same Kubernetes namespace.

## Background

There are typically two deployment styles when it comes to workloads such as
`tbot` which provide a service to other workloads in your cluster.

**Standalone Deployment**: `tbot` runs as a Kubernetes deployment, writing the
output credentials to a Kubernetes secret, which can then be mounted in the pods
that need to use the credentials.

**Sidecar**: `tbot` runs as a second container within the same pod as the
service that needs to use the credentials. The credentials are written to a
directory which is mounted within both the containers.

Due to the current limited support in Kubernetes for sidecars, we recommend that
the Standalone Deployment style is used. This style will be covered later in
this guide.

## Before you start

## Step 1/4. Prepare Kubernetes RBAC

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tbot
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tbot-secrets-admin
subjects:
  - kind: ServiceAccount
    name: tbot
roleRef:
  kind: Role
  name:  secrets-admin
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: default
  name: secrets-admin
rules:
  - apiGroups: [""] # "" indicates the core API group
    resources: ["secrets"]
    verbs: ["*"]
```


## Step 2/4. Create a join token and bot user

```yaml
kind: token
version: v2
metadata:
  name: bot-kubernetes
spec:
  roles: [Bot]
  bot_name: docker-desktop
  join_method: kubernetes
  kubernetes:
    type: static_jwks
    static_jwks:
      jwks: |
        {"keys":[{"use":"sig","kty":"RSA","kid":"KCk4tlf5yXj7GJ20L9XcvviNIiCf1QaUhw1Cyzd5VjA","alg":"RS256","n":"vYiAKomeNl--3-HaQ24DhJLlgg05gWIKmYRUxPx5vg4NLTdezUHxl70mygFNSYQrSgRqGpUp1j3_fOQYVKhWOVMPLtIYz4pnH-3mUBhNhpfLZiyMUqtjhijekqGOhlbEwHDvCm0tAMESSJBNHneR2tqEugsnDOpPmi3Z220MPJFO9FotFNd4vhmwEp9raWEIRSW3tRZiBoZ_1DAgR5LlO4q__sr125WL0n3s9exVrjQJxpkkUD4ECdO9020VtgPXL3sw__bE0UMuOWDvAY2sCb6rIN76rRLUbGc_IIP1ahLoFVDqdef-tsFM4pW_dbXu77YpfTfK_sTKOEVeGtKBJQ","e":"AQAB"}]}
    allow:
    - service_account: "default:tbot"
```

## Step 3/4. Create a `tbot` deployment

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: tbot-config
data:
  tbot.yaml: |
    version: v2
    onboarding:
      join_method: kubernetes
      token: bot-kubernetes
    storage:
      type: memory
    auth_server: example.teleport.sh:443
    outputs: [] # This section will be filled later in the guide.
```

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tbot
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: tbot
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tbot
    spec:
      containers:
        - name: tbot
          image: public.ecr.aws/gravitational/teleport:(=teleport.version=)
          command:
            - tbot
          args:
            - start
            - -c
            - /config/tbot.yaml
          env:
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: KUBERNETES_TOKEN_PATH
              value: /var/run/secrets/tokens/join-sa-token
          volumeMounts:
            - mountPath: /config
              name: config
            - mountPath: /var/run/secrets/tokens
              name: join-sa-token
      serviceAccountName: tbot
      volumes:
        - name: config
          configMap:
            name: tbot-config
        - name: join-sa-token
          projected:
            sources:
              - serviceAccountToken:
                  path: join-sa-token
                  expirationSeconds: 600
                  audience: example.teleport.sh
```

## Step 4/4. Configure Outputs

Follow one of the access guides to configure an output that produces the type
of credentials.

When configuring the outputs, use a Kubernetes secret destination (e.g):

```yaml
outputs:
  - type: identity
    destination:
      type: kubernetes_secret
      secret_name: identity-output
```

The output can then be consumed by mounting this secret within another pod:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: tsh
spec:
  containers:
    - name: tsh
      image: public.ecr.aws/gravitational/teleport:(=teleport.version=)
      command:
        - tsh
      args:
       - -i
       - /identity-output/identity
       - --proxy
       - example.teleport.sh:443
       - ls
      volumeMounts:
        - name: identity-output
          mountPath: /identity-output
  volumes:
    - name: identity-output
      secret:
        secretName: identity-output
```

## Further steps