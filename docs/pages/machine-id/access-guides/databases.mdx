---
title: Machine ID with Database Access
description: How to use Machine ID to access Database servers
---

(!docs/pages/includes/machine-id/v2-config-warning.mdx!)

Teleport Database Access protects and controls access to databases. Machine ID
can be used to grant machines secure, short-lived access to these databases.

In this guide, you will configure `tbot` to produce credentials that can be
used to access a database configured in Teleport Database Access.

<Figure align="left" bordered caption="Machine ID and Database Access Deployment">
![Machine ID and Database Access Deployment](../../../img/machine-id/machine-id-database-access.svg)
</Figure>

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- If you have not already put your database behind the Teleport Database Service,
  follow the [database access getting started guide](../../database-access/getting-started.mdx).
  The Teleport Database Service supports databases like PostgreSQL, MongoDB,
  Redis, and much more. See our [database access
  guides](../../database-access/guides.mdx) for a complete list.
- (!docs/pages/includes/tctl.mdx!)
- The `tsh` binary must be installed on the machine that will access the
  database. Depending on how `tbot` was installed, this may already be
  installed. If it is not, see [Installation](../../installation.mdx) for
  details.
- `tbot` must already be installed and configured on the machine that will
  access the Database. For more information, see the
  [platform guides](../platform-guides.mdx).

## Step 1/3. Configure RBAC

First, Teleport must be configured to allow the credentials produced by the bot
to access the database server and database.

If you have followed an access guide, you will have created a role and granted
the bot the ability to impersonate it already. This role just needs to have the
additional privileges added to it.

Use `tctl edit role/example-bot` to add the following rule to the role:

```yaml
spec:
  allow:
    db_labels:
      '*': '*'
    db_names: [example-db]
    db_users: [alice]
    rules:
      - resources: [db_server, db]
        verbs: [read, list]
```

Replace:

- `example-db` with the name of the database which the bot will be used to
  access.
- `alice` with the name of the user which the bot will use when connecting to
  the database.

This rule will allow the bot to do two things:

- Access the database `example` on any database server (due to the `'*': '*'`
  label selector) as the user `alice`.
- Discover information about database resources in Teleport.

The `'*': '*'` grants access to any database server configured in Teleport.
In production, consider restricting the bot's access using a more specific
label selector; see the
[Database Access RBAC guide](../../database-access/rbac.mdx) for more info.

## Step 2/3. Configure a database `tbot` output

Now, `tbot` needs to be configured with an output that will produce the
credentials needed for Database Access. To do this, the `database` output
type is used.

The database you///TODO///

Outputs must be configured with a destination. In this example, the `directory`
destination will be used. This will write artifacts to a specified directory on
disk. Ensure that this directory can be written to by the Linux user that
`tbot` runs as, and that it can be read by the Linux user that will be accessing
applications.

Modify your `tbot` configuration to add a `database` output:

```yaml
outputs:
- type: database
  destination:
    type: directory
    path: /opt/machine-id
  # Specify the details of the database you wish to connect to.
  service: example-server
  username: alice
  database: example
  # Specify a format to use for the output credentials. For most databases,
  # this configuration field can be omitted. See the table below for the
  # databases that require a value to be specified here.
  # format: mongo
```

The `format` field in the database output controls the format of the generated
credentials. This setting allows the credentials to work with database clients
that require a specific format. When this field is not specified, a sensible
default option is used that is compatible with most clients. The full list of
supported `format` options is below:

| Client        | `format`      | Description                          |
|---------------|---------------|--------------------------------------|
| Default       | Unspecified   | Provides a certificate in `tlscert`, a private key in `key` and the CA in `teleport-database-ca.crt`. This is compatible with most clients. |
| MongoDB       | `mongo`       | Provides `mongo.crt` and `mongo.cas`. |
| CockroachDB   | `cockroach`   | Provides `cockroach/node.key`, `cockroach/node.crt`, and `cockroach/ca.crt`. |
| Generic TLS   | `tls`         | Provides `tls.key`, `tls.crt`, and `tls.cas` for generic clients that require specific file extensions. |

If operating `tbot` as a background service, restart it. If running `tbot` in
one-shot mode, it must be executed before you attempt to execute the Ansible
playbook.

## Step 3/4 Configure the database access tunnel

TODO

Additionally, we'll need to create a secondary service to manage the database
proxy. Create another unit file at `/etc/systemd/system/machine-id-proxy.service`:

```systemd
[Unit]
Description=Teleport Machine ID Proxy Service
After=network.target
Requires=machine-id.service

[Service]
Type=simple
User=teleport
Group=teleport
Restart=on-failure
ExecStart=/usr/local/bin/tbot -c /etc/tbot.yaml proxy --proxy=proxy.example.com:3080 --destination-dir=/opt/machine-id db --port=12345 example-server
ExecReload=/bin/kill -HUP $MAINPID
PIDFile=/run/machine-id-proxy.pid
LimitNOFILE=8192

[Install]
WantedBy=multi-user.target
```

This will start a local proxy on port `12345` applications can use to connect
to the `example-server` database server. Be sure to customize the `tbot`
parameters as necessary for your local setup.

Finally, run the following commands to start Machine ID:

```code
$ sudo systemctl enable machine-id-proxy
$ sudo systemctl start machine-id-proxy
$ sudo systemctl status machine-id-proxy
```

<Admonition type="note" title="TLS Configuration Note">
If desired, you can add the `--tunnel` flag to the `tbot proxy db ...` command in the `machine-id-proxy.service` systemd unit file to
authenticate automatically at the proxy level, however this will decrease
security as all users of the system will be able to connect to the database
without any additional authentication.
</Admonition>

## Step 3/4. Update and run your application

In the default proxy mode, database clients must also be configured to use
`tbot`'s generated TLS certificates. This ensures no other users of the system
can access the database via the local proxy, and ensures the connection between
your database client and server is never unencrypted, even over localhost.

Once the necessary credentials for your database are ready to use, refer to
these sample Go programs to test connectivity to your database.

<Tabs>
  <TabItem label="Self-Hosted PostgreSQL">
  ```go
  (!docs/pages/includes/machine-id/postgresql/postgresql.go!)
  ```
  </TabItem>
  <TabItem label="Self-Hosted MongoDB">
  ```go
  (!docs/pages/includes/machine-id/mongodb/mongodb.go!)
  ```
  </TabItem>
</Tabs>

You are all set. You have provided your application with short-lived
certificates tied to a machine identity that can access your database, be
rotated, and audited, all while being controlled with all the familiar Teleport
access controls.

## Next steps

[More information about `TELEPORT_ANONYMOUS_TELEMETRY`.](../reference/telemetry.mdx)

