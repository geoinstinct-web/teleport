---
title: Machine ID with Kubernetes Access
description: How to use Machine ID to access Kubernetes clusters
---

(!docs/pages/includes/machine-id/v2-config-warning.mdx!)

Teleport Kubernetes Access protects and controls access to Kubernetes
clusters. Machine ID can be used to grant machines secure, short-lived
access to these clusters.

In this guide, you will configure `tbot` to produce credentials that can be
used to access a cluster configured in Teleport Kubernetes Access.

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- If you have not already connected your Kubernetes cluster to Teleport, follow
  the [Kubernetes Access Getting Started Guide](../../kubernetes-access/getting-started.mdx).

(!docs/pages/includes/machine-id/kubernetes-machineidnote.mdx!)

- (!docs/pages/includes/tctl.mdx!)
- To interact with the connected Kubernetes cluster, your client system
  will need to have `kubectl` installed. See the
  [Kubernetes documentation](https://kubernetes.io/docs/tasks/tools/) for
  installation instructions.
- `tbot` must already be installed and configured on the machine that will
  access Kubernetes clusters. For more information, see the
  [platform guides](../platform-guides.mdx).

## Step 1/3. Configure Teleport and Kubernetes RBAC

First, we need to configure the RBAC for both Teleport and Kubernetes in order
to grant the bot the correct level of access.

When forwarding requests to the Kubernetes API on behalf of a bot, the
Teleport Proxy attaches the groups configured (using `kubernetes_groups`) in the
bot's Teleport roles to the request. These groups are then used to configure a
RoleBinding or ClusterRoleBinding in Kubernetes to grant specific permissions
within the Kubernetes cluster to the bot.

For the purpose of this guide, we will bind the `editor` group to the default
`edit` ClusterRole that is preconfigured in most Kubernetes clusters to give
the bot read and write access to resources in all the cluster namespaces.

When configuring this for a production environment, you should consider:

- If RoleBinding should be used instead of ClusterRoleBinding to limit the
  bot's access to a specific namespace.
- If a Role should be created that grants the bot the least privileges
  necessary rather than using a pre-existing general Role such as `edit`.

To bind the `editor` group to the `edit` Cluster Role, execute:

```code
$ kubectl create clusterrolebinding teleport-editor-edit \
  --clusterrole=edit \
  --group=editor
```

With the appropriate RoleBinding configured in Kubernetes to grant access to
a specific group, you now need to add this group to the role that the bot
will impersonate when producing credentials. You also need to grant the bot
access through Teleport to the cluster itself.

If you have followed an access guide, you will have created a role and granted
the bot the ability to impersonate it already. This role just needs to have the
additional privileges added to it.

Use `tctl edit role/example-bot` to add the following rule to the Teleport role:

```yaml
spec:
  allow:
    kubernetes_labels:
      '*': '*'
    kubernetes_resources:
    - kind: pod
      namespace: "*"
      name: "*"
    kubernetes_groups:
    - editor
```

Adjust the `allow` field for your environment:

- `kubernetes_labels` should be adjusted to grant access to only the clusters
  that the bot will need to access. The value shown, `'*': '**'` will grant
  access to all Kubernetes clusters.

- Each item in `kubernetes_resources` must match the namespace and name of a
  Kubernetes resource that you would like users with `machine-id-kube-role` to
  access. Currently, Teleport only supports the `pod` kind. In the
  configuration above, this role can access all pods in all namespaces.

- `editor` must match the name of the group you specified in the
  RoleBinding or ClusterRoleBinding.

## Step 2/3. Configure the `tbot` output

Now, `tbot` needs to be configured with an output to produce the Kubernetes
credentials and client configuration file. This is done using the `kubernetes`
output type.

The `kubernetes` output type will generate a `kubeconfig.yaml` artifact which
can be used with `kubectl` and other Kubernetes clients to access the cluster.
The output must be configured with a destination and the name of the
Kubernetes cluster that should be encoded in the credentials produced by `tbot`.

Modify your `tbot` configuration to add a `kubernetes` output:

```yaml
outputs:
  - type: kubernetes
    # Specify the name of the Kubernetes cluster you wish the credentials to
    # grant access to.
    kubernetes_cluster: example-k8s-cluster
    destination:
      type: directory
          # For this guide, /opt/machine-id is used as the destination directory.
          # You may wish to customize this. Multiple outputs cannot share the same
          # destination.
      path: /opt/machine-id
```

Ensure you replace `example-k8s-cluster` with the name of the Kubernetes cluster
as registered in Teleport and adjust `/opt/machine-id` if you wish

If operating `tbot` as a background service, restart it. If running `tbot` in
one-shot mode, it must be executed before you attempt to use the credentials.

## Step 3/3. Connect to your Kubernetes cluster with the Machine ID identity

Once `tbot` has been run with the new output configured, `kubeconfig.yaml`
should have been generated in the destination directory you specified.

The `kubeconfig.yaml` contains all the information necessary for `kubectl` to
connect to the Kubernetes cluster through the Teleport Proxy. As well as being
compatible with `kubectl`, it is also compatible with most other tools that
connect to Kubernetes clusters (e.g Helm).

To use the `kubeconfig.yaml` file, the `--kubeconfig` flag or `KUBECONFIG`
environment variable can be provided to `kubectl`:

```code
$ kubectl --kubeconfig /opt/machine-id/kubeconfig.yaml get pods -A
# Or, set the KUBECONFIG environment variable:
$ export KUBECONFIG=/opt/machine-id/kubeconfig.yaml
$ kubectl get pods -A
```

## Next steps

[More information about `TELEPORT_ANONYMOUS_TELEMETRY`.](../reference/telemetry.mdx)
