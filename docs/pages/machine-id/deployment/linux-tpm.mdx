---
title: Deploying Machine ID on Linux (TPM)
description: How to install and configure Machine ID on a Linux host and use a TPM 2.0 for authentication
---

This page explains how to deploy Machine ID on a Linux host, and use the
secure identify of the onboard TPM 2.0 chip for authenticating with the
Teleport cluster.

## Background

A Trusted Platform Module (TPM) is a secure, physical, cryptoprocessor that is
installed on a host. TPMs can store cryptographic material and perform a number
of cryptographic operations, without exposing the cryptographic material to the
operating system. Each TPM has a unique public/private key pair burned-in known
as the Endorsement Key (EK).

Some TPMs also contain an X.509 certificate for this key pair that is signed by
the manufacturer's CA, this is known as the EK Certificate (EKCert). This
certificate can be used by the TPM to prove to a third-party (who trusts the
manufacturer's CA) that the TPM is genuine and abides by the TPM specification.

The `tpm` join method is a secure way for Bots and Agents to authenticate with
a Teleport cluster using a TPM and without using any shared secrets as with the
`token` join method. This is ideal for on-prem environments where other
delegated join methods cannot be used.

When using the `tpm` join method, you must first "enroll" the TPM by querying
it, and then creating a join token based on the characteristics of the TPM.
Even if the host operating system is reinstalled, these characteristics will
not change, meaning that the TPM will still be usable to join your Teleport
cluster. If you have a large number of hosts, it may make sense to use
automation tooling such as ansible to query the TPMs across your fleet and then
generate join tokens.

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- (!docs/pages/includes/tctl.mdx!)
- A Linux host that you wish to install Machine ID onto, with a TPM2.0
  installed.
- A Linux user on that host that you wish Machine ID to run as. In the guide,
we will use `teleport` for this.

## Step 1/5. Install `tbot`

**This step is completed on the Linux host.**

First, `tbot` needs to be installed on the VM that you wish to use Machine ID
on.

Download the appropriate Teleport package for your platform:

(!docs/pages/includes/install-linux.mdx!)

### Granting `tbot` access to the TPM device

If the user that will run `tbot` is not `root`, you will also need to configure
Linux to allow the user to access the TPM device.

The simplest way to solve this is to check if your distro ships with the `tss`
group and assign it the user. If that is not possible, or you are looking
for a different solution, we recommend creating udev rules similar to the ones
shipped by the [TPM2 Software Stack](
https://github.com/tpm2-software/tpm2-tss/blob/ede63dd1ac1f0a46029d457304edcac2162bfab8/dist/tpm-udev.rules#L4).

## Step 2/5. Create a `tpm` join token

### Determining the EKPub Hash or EKCert Serial for your TPM

### Obtaining the manufacturer CA

### Creating the join token

Create a file named `bot-token.yaml`. Ensure you substitute any values as
suggested by the comments in this example:

```yaml
```

Apply this to your Teleport cluster using `tctl`:

```code
$ tctl create -f bot-token.yaml
```

## Step 3/5. Create a Bot

Create the bot, specifying the name of the token you have created:

```code
$ tctl bots add example --token example-bot
```

## Step 4/5. Configure `tbot`

Create `/etc/tbot.yaml`:

```yaml
version: v2
proxy_server: example.teleport.sh:443
onboarding:
  join_method: token
  token: (=presets.tokens.first=)
storage:
  type: directory
  path: /var/lib/teleport/bot
# outputs will be filled in during the completion of an access guide.
outputs: []
```

Replace:
- `example.teleport.sh:443` with the address of your Teleport Proxy or
Auth Server. Prefer using the address of a Teleport Proxy.
- `(=presets.tokens.first=)` with the token that was returned by `tctl bots add`
in the previous step.

<Notice type="note">
    The first time that `tbot` runs, this token will be exchanged for a certificate
    that the bot uses for authentication. At this point, the token is invalidated.
    This means you may remove the token from the configuration file after the first
    run has completed, but there is no tangible security benefit to doing so.
</Notice>

### Prepare the storage directory

When using the `token` join method, `tbot` must be able to persist its state
across restarts. The destination used to persist this state is known as the
bot's "storage destination". In this guide, the directory
`/var/lib/teleport/bot` will be used.

As this directory will store the bots sensitive credentials, it is important
to protect it. To do this, you will configure the directory to only be
accessible to the Linux user which `tbot` will run as.

Execute the following, replacing `teleport` with the Linux user that you will
run `tbot` as:

```code
# Make the bot directory and assign ownership to teleport user
$ sudo mkdir -p /var/lib/teleport/bot
$ sudo chown teleport:teleport /var/lib/teleport/bot
```

### Create a systemd service

(!docs/pages/includes/machine-id/daemon.mdx!)

## Step 5/5. Configure outputs

(!docs/pages/includes/machine-id/configure-outputs.mdx!)

## Next steps

- Follow the [access guides](../access-guides.mdx) to finish configuring `tbot` for
your environment.
- Read the [configuration reference](../reference/configuration.mdx) to explore
all the available configuration options.
- [More information about `TELEPORT_ANONYMOUS_TELEMETRY`.](../reference/telemetry.mdx)