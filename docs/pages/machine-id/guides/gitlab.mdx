---
title: Using Machine ID with GitLab
description: How to use Machine ID to SSH into Teleport nodes from GitLab CI
---

<Details
  title="Version warning"
  opened={true}
  scope={["oss", "enterprise"]}
  scopeOnly={true}
  min="12.2"
>
  Machine ID for GitLab is available starting from Teleport `v12.2`.
</Details>

In this guide, you will use Teleport Machine ID to allow a GitLab pipeline to
securely connect to a Teleport SSH node without the need for long-lived secrets.

Machine ID for GitLab works with GitLab's cloud-hosted option and with
self-hosted GitLab installations. **The minimum supported GitLab version is
15.7**.

This mitigates the risk of long-lived secrets such as passwords or SSH private
keys being exfiltrated from your GitLab organization and provides many of
the other benefits of Teleport such as auditing and finely-grained access
control.

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

(!docs/pages/includes/tctl.mdx!)

- A running instance of the Teleport SSH Service that you have registered with
your Teleport cluster. For instructions on setting this up, see the
[Getting Started Guide](../../server-access/introduction.mdx). The SSH node must
include a user you want to grant access to. In this guide, we will call the SSH
node `my-node` and the user `ci-user`. Replace these with values appropriate to
your setup.
- A GitLab project you wish to use. This can either be on GitLab's cloud-hosted
offering (gitlab.com) or on a self-hosted GitLab instance. **When using a
self-hosted GitLab instance, your Teleport Auth Server must be able to connect
to your GitLab instance and your GitLab instance must be configured with a valid
TLS certificate.**

## Step 1/3. Create a join token

In order to allow your GitLab CI to authenticate to your Teleport cluster,
you'll first need to create a join token. These tokens define the rules that
allow a bot to join your Teleport cluster.

A GitLab join token contains allow rules that describe which pipelines should
be able to use that token in order to join the Teleport cluster. A rule can
contain multiple constraints, and any pipeline that matches all of the
constraints within a single rule is granted access.

The following constraints exist:
- `sub`: a string uniquely identifying the CI run's source. It follows the
  following format:
  `project_path:{group}/{project}:ref_type:{type}:ref:{branch_name}`
- `ref`: the git reference that triggered the CI run
- `ref_type`: the type of reference that triggered the CI run. This will either
  be `branch` or `tag`
- `namespace_path`: the group or user that the project belongs to.
- `project_path`: the full name of the project that the run belongs to. For
example: `mygroup/myproject`
- `pipeline_source`: the trigger of the CI run. For example: `web`
- `environment`: the environment that the job is associated with

A full explanation of these constraints values can be found on the [GitLab
Documentation.](https://docs.gitlab.com/ee/ci/secrets/id_token_authentication.html#token-payload)

In this example, you will create a rule that grants access to any GitLab CI job
within a specific GitLab project. Determine the fully qualified path of your
GitLab project. This will include your username (or group) and the name of your
project, e.g `my-user/my-project`.

Create a file named `gitlab-token.yaml`. Ensure you substitute any values as
suggested by the comments in this example.

```yaml
kind: token
version: v2
metadata:
  name: gitlab-demo
spec:
  roles: [Bot]
  join_method: gitlab
  bot_name: gitlab-demo
  gitlab:
    # domain should be the domain of your GitLab instance. If you are using
    # GitLab's cloud hosted offering, omit this field entirely.
    domain: gitlab.example.com
    allow:
        # project_path should be the fully qualified path of your GitLab
        # project that you determined earlier.
      - project_path: my-user/my-project
```

Apply this to your Teleport cluster using `tctl`:

```code
$ tctl create -f gitlab-token.yaml
```

## Step 2/3. Create a Machine ID bot

With the join token created, the next step is to create the Machine ID bot that
the token will grant access to.

In this example, the bot is given the default `access` role. In a production
environment, the principle of least privilege should be applied and you should
create a role that grants the bot access to the precise resources that will be
needed in your CI/CD pipeline.

Enter the following command from your workstation with `tsh` access, replacing
the `ci-user` login with a Linux user on the host that you want your GitLab
pipeline to be able to connect to:

```code
$ tctl bots add gitlab-demo --roles=access --token=gitlab-demo --logins=ci-user
```

## Step 3/3. Configure a GitLab Pipeline

With the bot and join token created, you can now create a GitLab pipeline that
uses these to access a node in your cluster.

Create a file called `.gitlab-ci.yml` in the root of your repository. Replace
`teleport.example.com:443` with the public address of your Teleport Proxy
and `my-node` and `ci-user` with the user and host you wish to connect to.

```yaml
stages:
  - deploy

deploy-job:
  stage: deploy
  id_tokens:
    TBOT_GITLAB_JWT:
      aud: teleport.example.com
  script:
    - 'cd /tmp'
    - 'curl -O https://cdn.teleport.dev/teleport-v(=teleport.version=)-linux-amd64-bin.tar.gz'
    - 'tar -xvf teleport-v(=teleport.version=)-linux-amd64-bin.tar.gz'
    - 'sudo ./teleport/install'
    - 'tbot start --token=gitlab-demo --destination-dir=/tmp/tbot-user --data-dir=/tmp/tbot-data --auth-server=teleport.example.com:443 --join-method=gitlab --oneshot'
    - 'tsh -i /tmp/tbot-user/identity --proxy teleport.example.com:443 ssh ci-user@my-node "echo $CI_JOB_ID >> ~/gitlab_run_log"'
```

Commit and push this to the repository. Check your GitLab CI status, and examine
the log results from the commit for failure. If the job has succeeded, you
should see a file in the home directory of `ci-user` called `gitlab_run_log`
that includes the ID of the CI run.

## Further steps

For more information about GitLab itself, read
[their documentation](https://docs.gitlab.com/ee/ci/).

[More information about `TELEPORT_ANONYMOUS_TELEMETRY`.](../reference/telemetry.mdx)
