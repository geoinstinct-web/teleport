---
title: Host Certificates with Machine ID
description: Issuing Host Certificates with Machine ID
---

In this guide, you will learn how to create host certificates through Machine ID for OpenSSH servers. This allows for the benefits of
Machine ID with OpenSSH nodes and reduces risk by ensuring that short-lived certificates issued to tbot users on Teleport clusters can be successfully applied.

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

(!/docs/pages/includes/tctl.mdx!)

- OpenSSH server `sshd` version 6.9 or above installed. The SSH port on this host must be open to traffic from the Teleport Proxy Service host.

  ```code
  $ ssh -V
  ```

- A host that you wish to assign an identity to using Machine ID.

## Step 1/4. Download and install Teleport (=teleport.version=)

In this step, you will be downloading and installing Teleport binaries onto the
machine you wish to assign an identity to.

Each Teleport package hosted on our downloads page ships with several useful
binaries, including `teleport`, `tctl`, `tsh`, and `tbot`:

- `teleport` is the daemon used to initialize a Teleport cluster; this binary is not used in this guide.
- `tctl` is the administrative tool you will use to create the bot user.
- `tsh` is the client tool you will use to log in to the Teleport Cluster.
- `tbot` is the Machine ID tool you will use to associate a bot user with a machine.

Next, log in to your cluster using `tsh` to ensure that your machine will be able to interact with the cluster:

```code
tsh login --proxy=myteleportcluster.com --user=teleport-username
```


## Step 2/4. Create a Role to Issue `tbot` Certificates

In order to create certificates with Tbot, a role must be created that provides the necessary permissions. Tbot configurations support certificate **principals** and **predicates**,
or strings which are used to reduce the scope of access the bot will have when accessing a specific host.
By using the format of `where: 'predicate(host_cert.principals, "domain.name")'`, a Teleport user can create a role that will only be able to able to effect the designated domain name
in a manner defined by the selected predicate. A full list of predicates and their behavior are listed below:

| **Predicate** | **Behavior** |
| ----------- | ----------- |
| eguals | Created domain must be equal to the domain. |
| contains | Created domains must contain the domain in some way. |
| all_equal | All created domains must be equal to the domain. |
| all_end_with | All created domains or subdomains must end with the selected domain. |
| is_subset | All created domains must be a subset of the selected domain. This requires the certificate requested by tbot to be be listed with the role's predicate. |

In the case of an example role for use within this guide, use a text editor of your choice to create a role YAML named `tbotrole.yaml` with the following configuration options, replacing `my.domain.com` with your own primary domain name,
or the domain associated with your cluster:

```code
 kind: role
metadata:
  name: hostcert-bot
version: v5
spec:
  allow:
    rules:
      - resources:
          - host_cert
        verbs:
          - create
          - list
          - read
          - update
          - delete
        where: 'all_end_with(host_cert.principals, ".my.domain.com")'
```

Once complete, create your role to apply to the tbot configuration in the next step:

```code
$ tctl create tbotrole.yaml
```


### Step 3/4 Create Your `tbot` Configuration

Before you create a bot user, you need to determine which role(s) you want to
assign to it. You can use the `tctl` command below to examine what roles exist
on your system.

<ScopedBlock scope={["cloud"]}>
On your client machine, log in to Teleport using `tsh`, then use `tctl` to examine
what roles exist on your system.
</ScopedBlock>
<ScopedBlock scope={["oss","enterprise"]}>
Connect to the Teleport Auth Server and use `tctl` to examine what roles exist on
your system.
</ScopedBlock>

```code
$ tctl get roles --format=text
```

You will see something like the output below on a fresh install of Teleport with the
default rolesâ€”your cluster may have different roles. In this example, let's
assume you want to give the bot the `hostcert-bot` role to allow it to generate host certificates.

```
Role    Allowed to login as                           Node Labels Access to resources
------- --------------------------------------------- ----------- ----------------------------------------
access  {{internal.logins}}                           <all nodes> event:list,read,session:read,list
auditor no-login-6566121f-b602-47f1-a118-c9c618ee5aec             session:list,read,event:list,read
editor
hostcert-bot  host_cert:create,list,read,update,delete             user:list,create,read,update,delete,...
```

Machine ID can join with a `token` or the [IAM Method](https://goteleport.com/docs/setup/guides/joining-nodes-aws) on AWS.

While any role with permissions for logging into nodes will work, this guide will additionally make use of the default
`access` role to ensure that the tbot user can successfully log in. Use the `--logins` flag when adding your bot to specify the SSH logins that you wish to 
allow the bot to access on hosts. For our example, we will be using `root`.

<Tabs>
  <TabItem label="Token-based Joining">
  ```code
  $ tctl bots add robot --roles=hostcert-bot,access --logins=root
  ```
  </TabItem>
  <TabItem label="IAM Method">
  First, create an IAM method token that specifies the AWS account from which
  the bot can join. Create the below file as `iam-token.yaml` then run `tctl
  create -f iam-token.yaml`.

  ```
  kind: token
  version: v2
  metadata:
    # The token name is not a secret because instances must prove that they are
    # running in your AWS account to use this token.
    name: iam-token
    # Set a long expiry time for how long you want to support IAM method for
    # joining. It is safe to set this value to a very long time.
    expires: "3000-01-01T00:00:00Z"
  spec:
    # Only allow bots to join using this token.
    roles: [Bot]

    # Set the join method to be IAM.
    join_method: iam

    # Define the name of the bot that will be allowed to use this token.
    bot_name: robot

    allow:
    # Restrict the AWS account and (optionally) ARN that can use this token.
    # This information can be obtained from running the
    # "aws sts get-caller-identity" command from the CLI.
    - aws_account: "111111111111"
      aws_arn: "arn:aws:sts::111111111111:assumed-role/teleport-bot-role/i-*"
  ```

  Next, create the bot user.

  ```
  $ tctl bots add robot --token=iam-token --roles=access --logins=root
  ```
  </TabItem>
</Tabs>


Machine ID may now be configured using the `tbot configure` command.

First, create a basic configuration file using the following parameters:

<Tabs>
  <TabItem label="Token-based Joining">

  <ScopedBlock scope={["oss", "enterprise"]}>

  ```code
  $ tbot configure \
     --data-dir=/var/lib/teleport/bot \
     --token=(=presets.tokens.first=) \
     --join-method=token \
     --certificate-ttl=1h0m0s \
     --ca-pin=(=presets.ca_pin=) \
     --auth-server=auth.example.com:3025
  ```

  </ScopedBlock>
  <ScopedBlock scope={["cloud"]}>

  ```code
  $ tbot configure \
     --data-dir=/var/lib/teleport/bot \
     --token=(=presets.tokens.first=) \
     --join-method=token \
     --certificate-ttl=1h0m0s \
     --ca-pin=(=presets.ca_pin=) \
     --auth-server=example.teleport.sh:443
  ```

  </ScopedBlock>

  </TabItem>
  <TabItem label="IAM Method">

  <ScopedBlock scope={["oss", "enterprise"]}>

  ```code
  $ tbot configure \
     --data-dir=/var/lib/teleport/bot \
     --token=iam-token \
     --join-method=iam \
     --certificate-ttl=1h0m0s \
     --ca-pin=(=presets.ca_pin=) \
     --auth-server=auth.example.com:3025
  ```

  </ScopedBlock>
  <ScopedBlock scope={["cloud"]}>

  ```code
  $ tbot configure \
     --data-dir=/var/lib/teleport/bot \
     --token=iam-token \
     --join-method=iam \
     --certificate-ttl=1h0m0s \
     --ca-pin=(=presets.ca_pin=) \
     --auth-server=example.teleport.sh:443
  ```

  </ScopedBlock>

  </TabItem>
</Tabs>

Replace the following fields with values from your own cluster.

<ScopedBlock scope={["cloud"]}>

- `token` is the token output by the `tctl bots add` command or the name of your IAM method token.
- `ca-pin` is the CA Pin for your Teleport cluster, and is output by the `tctl bots add` command.
- `data-dir` is where Machine ID writes its private data, including its own short-lived renewable certificates. These should not be used by applications and tools.
- `auth-server` is the address of your Teleport Cloud Proxy Server, for example `example.teleport.sh:443`.
- `certificate-ttl` is the option that will result in creation of a host certificate with Machine ID. The default TTL is for one hour, meaning that all generated certificates will expire after one hour's time.

</ScopedBlock>
<ScopedBlock scope={["oss","enterprise"]}>

- `token` is the token output by the `tctl bots add` command or the name of your IAM method token.
- `ca-pin` is the CA Pin for your Teleport cluster, and is output by the `tctl bots add` command.
- `data-dir` is where Machine ID writes its private data, including its own short-lived renewable certificates. These should not be used by applications and tools.
- `certificate-ttl` is the option that will result creation of a host certificate with Machine ID. The default TTL is for one hour, meaning that all generated certificates will expire after one hour's time.
- `auth-server` is the address of your Teleport Auth Server, for example
  `auth.example.com:3025`. If your Machine ID host is in a different network
  than your Auth Server, use the public web address of your Proxy Service
  instead (e.g., `auth.example.com:443`).


</ScopedBlock>

Using a text editor of your choice, write the output generated by the `tbot configure` command to a configuration YAML file, in this example we'll be using `tbot.yaml`.

Once complete, the Machine ID configuration will still require a destination directory to be manually referenced within the configuration file. The destination directory is where Machine ID will write user certificates
which can be used by application and tools to start Machine ID. In the configuration yaml `tbot.yaml`, this configuration will additionally be used to designate the **principal**,
in this case the Domain Name that we'll be applying to the tbot configuration to access a Node.
The new configuration YAML will require a `destination` field and `ssh_host_cert` subfield that resembles the following, replacing `nodename.my.domain.com` with your own required domain name:

```
destinations:
  - directory:
      path: /opt/machine-id
    configs:
      - ssh_host_cert:
          principals: [nodename.my.domain.com]
```

Once completed, your `tbot.yaml` configuration should resemble the following:

```
onboarding:
  token: "1234abcd5678efgh9"
  ca_path: ""
  ca_pins:
  - sha256:1234abcd5678efgh910ijklmnop
  join_method: token
storage:
  directory:
    path: /var/lib/teleport/bot
    symlinks: secure
    acls: try
destinations:
  - directory:
      path: /opt/machine-id
    configs:
      - ssh_host_cert:
          principals: [nodename.my.domain.com]
debug: false
auth_server: example.teleport.sh:443
certificate_ttl: 1h0m0s
renewal_interval: 20m0s
oneshot: false
```

Note the `renewal_interval` field, which will determine the cadence in which new certificates will be generated. Machine ID uses a default of 20 minutes for the `renewal_interval`, however this field may be adjusted as needed.

## Step 4/4 Start Machine ID and create a host certificate

Using your configuration file, The `tbot start -c` command will start running Machine ID in a loop,
writing renewable certificates to /var/lib/teleport/bot according to your configuration, and the short-lived certificates including the Host Certificate your bot will use to `/opt/machine-id`.

In a production environment you will want to run Machine ID in the background using a service manager like systemd. However, in this guide you will run it in the foreground to better understand how it works.

```code
$ tbot start -c tbot.yaml
```

Now that Machine ID has successfully started, let's investigate the /opt/machine-id directory to see what was written to disk.

```code
$ ls -1 /opt/machine-id
identity
key
key-cert.pub
key.pub
known_hosts
ssh_config
ssh_host
ssh_host-cert.pub
teleport-database-ca.crt
teleport-host-ca.crt
teleport-user-ca.crt
tlscert
```

The public host certificate and private key Machine ID will be generating can be found within the `ssh_host-cert.pub` and `ssh_host` file. To confirm this,
view the public certificates contents by entering the following command:

```code
$ sudo ssh-keygen -L -f /opt/machine-id/key-cert.pub
```

The contents of the public certificate will appear, and will contain a `principals` field which will contain the `nodename.my.domain.com` domain entered in a previous step.
Your output will resemble the following:

```
        Type: ssh-rsa-cert-v01@openssh.com host certificate
        Public key: RSA-CERT SHA256:abcde123efghijk567lmnop
        Signing CA: RSA SHA256:abcde123efghijk567lmnop (using rsa-sha2-512)
        Key ID: ""
        Serial: 0
        Valid: from 2022-09-30T13:16:36 to 2022-09-30T17:17:36
        Principals:
                nodename.my.domain.com
        Critical Options: (none)
        Extensions:
                x-teleport-authority UNKNOWN OPTION (len 55)
                x-teleport-role UNKNOWN OPTION (len 8)
```

## Next Steps

Now that Host Certificates have been created with machine ID, they can be applied to OpenSSH configurations as needed. For more information regarding the next steps
to connect to OpenSSH with Machine ID, see the following documentation:

- [Using Teleport With OpenSSH](../server-access/guides/openssh/)
- [Using SSH Host Certificates](https://goteleport.com/blog/how-to-ssh-properly/)
- [Machine ID Configuration Reference](../machine-id/reference/configuration/)
































