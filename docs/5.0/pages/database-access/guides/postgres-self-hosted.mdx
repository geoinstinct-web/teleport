---
title: Database Access with Self-Hosted PostgreSQL
description: How to configure Teleport Database Access with self-hosted PostgreSQL
---

# Self-Hosted PostgreSQL

## Create Certificate/Key Pair

Teleport uses mutual TLS for authentication to PostgreSQL instances. As such,
self-hosted PostgreSQL instances must be configured with Teleport's certificate
authority and a certificate/key pair that Teleport can validate.

To create these secrets, use `tctl auth sign` command. Note that it requires a
running Teleport cluster and [should be run](../../architecture/overview.mdx#tctl)
on the auth server.

```sh
# Export Teleport's certificate authority and generate certificate/key pair
# for host db.example.com with a one year validity period.
$ tctl auth sign --format=db --host=db.example.com --out=server --ttl=8760h
```

Flag descriptions:

* `--format=db`: instructs the command to produce secrets in the format suitable
  for configuring a database server.
* `--host=db.example.com`: server name to encode in the certificate, should
  match the hostname Teleport will be connecting to the database at.
* `--out=server`: name prefix for output files.
* `--ttl=8760h`: certificate validity period.

The command will create 3 files: `server.cas` with Teleport's certificate
authority and `server.crt`/`server.key` with generated certificate/key pair.

<Admonition type="note" title="Certificate Rotation">
Teleport signs database certificates with the host authority. As such,
when performing [host certificates rotation](../../admin-guide.mdx#certificate-rotation),
the database certificates must be updated as well.
</Admonition>

## Configure PostgreSQL Server

To configure PostgreSQL server to accept TLS connections, add the following
to PostgreSQL configuration file `postgresql.conf`:

```conf
ssl = on
ssl_cert_file = '/path/to/server.crt'
ssl_key_file = '/path/to/server.key'
ssl_ca_file = '/path/toa/server.cas'
```

See [Secure TCP/IP Connections with SSL](https://www.postgresql.org/docs/current/ssl-tcp.html)
in PostgreSQL documentation for more details.

Additionally, PostgreSQL should be configured to require client certificate
authentication from clients connecting over TLS. This can be done by adding
the following entries to PostgreSQL host-based authentication file `pg_hba.conf`:

```conf
hostssl all             all             ::/0                    cert
hostssl all             all             0.0.0.0/0               cert
```

See [The pg_hba.conf File](https://www.postgresql.org/docs/current/auth-pg-hba-conf.html)
in PostgreSQL documentation for more details.

## Configure Teleport

Teleport Database Access is available starting from `6.0.0-alpha.1` pre-release.

Download the appropriate version of Teleport for your platform from the table
below, or visit our [downloads page](https://goteleport.com/teleport/download).

{!docs/5.0/pages/preview/releases-table.mdx!}

<Admonition type="warning" title="Version Warning">
Note, pre-releases are not suitable for production usage!
</Admonition>

Follow the installation [instructions](../../installation.mdx).

### Start Auth/Proxy Service

Create a configuration file for a Teleport service that will be running
auth and proxy servers:

```yaml
teleport:
  data_dir: /var/lib/teleport
  nodename: test
auth_service:
  enabled: "yes"
  cluster_name: "test"
  listen_addr: 0.0.0.0:3025
  tokens:
  - proxy,node,db:cbdeeab9-6f88-436d-a673-44d14bd86bb7
proxy_service:
  enabled: "yes"
  listen_addr: 0.0.0.0:3023
  tunnel_listen_addr: 0.0.0.0:3024
  public_addr: teleport.example.com:3080
  # PostgreSQL proxy is listening on a regular web proxy port.
  web_listen_addr: 0.0.0.0:3080
ssh_service:
  enabled: "no"
```

Start the service:

```sh
$ teleport start --debug --config=/path/to/teleport.yaml
```

### Start Database Service with CLI Flags

For a quick try-out, Teleport database service doesn't require a configuration
file and can be launched using a single CLI command:

```sh
$ teleport start --debug \
   --roles=db \
   --token=cbdeeab9-6f88-436d-a673-44d14bd86bb7 \
   --auth-server=teleport.example.com:3080 \
   --db-name=test \
   --db-protocol=postgres \
   --db-uri=postgres.example.com:5432 \
   --labels=env=dev
```

Note that the `--auth-server` flag must point to cluster's proxy endpoint
because database service always connects back to the cluster over a reverse
tunnel.

Instead of using a static auth token, a short-lived dynamic token can also
be generated for a database service:

```sh
$ tctl tokens add \
    --type=db \
    --db-name=test \
    --db-protocol=postgres \
    --db-uri=postgres.example.com:5432
```

### Start Database Service with Config File

Below is an example of a database service configuration file that proxies
a single self-hosted PostgreSQL database:

```yaml
teleport:
  data_dir: /var/lib/teleport-db
  nodename: test
  # Auth token to connect to the auth server.
  auth_token: cbdeeab9-6f88-436d-a673-44d14bd86bb7
  # Proxy address to connect to. Note that it has to be the proxy address
  # because database service always connects to the cluster over reverse
  # tunnel.
  auth_servers:
  - teleport.example.com:3080
db_service:
  enabled: "yes"
  # This section contains definitions of all databases proxied by this
  # service, can contain multiple items.
  databases:
    # Name of the database proxy instance, used to reference in CLI.
  - name: "example"
    # Free-form description of the database proxy instance.
    description: "Example PostgreSQL"
    # Database protocol.
    protocol: "postgres"
    # Database address, PostgreSQL server endpoint in this case.
    #
    # Note: this URI's hostname must match the host name specified via --host
    # flag to tctl auth sign command.
    uri: "postgres.example.com:5432"
    # Labels to assign to the database, used in RBAC.
    static_labels:
      env: dev
auth_service:
  enabled: "no"
ssh_service:
  enabled: "no"
proxy_service:
  enabled: "no"
```

<Admonition type="tip" title="Tip">
A single Teleport process can run multiple different services, for example
multiple database access proxies as well as running other services such as an
SSH service or an application access proxy.
</Admonition>

Start the database service:

```sh
$ teleport start --debug --config=/path/to/teleport-db.yaml
```

## Connect

Once the database service has joined the cluster, login to see the available
databases:

```sh
$ tsh login --proxy=teleport.example.com:3080
$ tsh db ls
Name    Description        Labels
------- ------------------ --------
example Example PostgreSQL env=dev
```

Note that you will only be able to see databases your role has access to. See
[RBAC](../rbac.mdx) section for more details.

To connect to a particular database server, first retrieve credentials from
Teleport using `tsh db login` command:

```sh
$ tsh db login example
```

<Admonition type="tip" title="Tip">
You can be logged into multiple databases simultaneously.
</Admonition>

You can optionally specify the database name and the user to use by default
when connecting to the database instance:

```sh
$ tsh db login --db-user=postgres --db-name=postgres example
```

When logging into a PostgreSQL database, `tsh` automatically configures a section
in the [connection service file](https://www.postgresql.org/docs/current/libpq-pgservice.html)
with the name of `<cluster-name>-<database-service-name>`.

Suppose the cluster name is "root", then you can connect to the database using
the following `psql` command:

```sh
# Use default database user/name.
$ psql "service=root-example"
# Specify database name/user explicitly.
$ psql "service=root-example user=alice dbname=metrics"
```

To log out of the database and remove credentials:

```sh
# Remove credentials for a particular database instance.
$ tsh db logout example
# Remove credentials for all database instances.
$ tsh db logout
```
