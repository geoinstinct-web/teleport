timeout: 25m
options:
  machineType: E2_HIGHCPU_32

steps:
  # GCB does a shallow checkout for a build, but if we want to check our changes
  # against other branches we'll need to fetch the repo history.
  - name: gcr.io/cloud-builders/git
    id: fetch-history
    args: ['fetch', '--unshallow']

  # Set up BCC headers in a volume to replace the incompatible system-level 
  # headers
  - name: quay.io/gravitational/teleport-buildbox:go1.15.5
    id: configure BCC headers
    volumes: 
      - name: bcc-headers
        path: /usr/include/bcc
    entrypoint: /bin/bash
    args: 
      - -c
      - cp -R /workspace/build.assets/bcc/* /usr/include/bcc

  # Run the integration tests. Actual content of this job depends on the changes 
  # detected in the PR
  - name: quay.io/gravitational/teleport-buildbox:go1.15.5
    id: run-tests
    volumes: 
      - name: bcc-headers
        path: /usr/include/bcc

    dir: /workspace/.cloudbuild/scripts
    entrypoint: bash
    args: 
      - -c
      - go run ./cmd/integration-tests -w=/workspace -t=$_BASE_BRANCH -c=HEAD
    timeout: 20m
